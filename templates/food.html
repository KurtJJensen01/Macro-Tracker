{% extends "base.html" %}
{% block content %}

<form method="GET" action="{{ url_for('food_log') }}" id="dateForm">
    <label for="date">Select Date:</label>
    <input type="date" id="date" name="date" value="{{ selected_date }}" required>
    <button type="button" id="todayBtn">Today</button>
</form>

<script>
    const dateInput = document.getElementById('date');
    const form = document.getElementById('dateForm');

    dateInput.addEventListener('change', function() {
        form.submit();
    });

    document.getElementById('todayBtn').addEventListener('click', function() {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        form.submit();
    });
</script>


<form method="POST" id="food-form">
    <label for="saved-foods">Choose saved food (optional):</label>
    <select id="saved-foods" name="saved_food" onchange="fillMacros()">
        <option value="">-- Select Saved Food --</option>
        {% for food in saved_foods %}
            <option value="{{ food[1] }}">{{ food[1] }}</option>  <!-- assuming food[1] is name -->
        {% endfor %}
    </select><br><br>
  <label for="name">Name:</label><br>
  <input type="text" name="name" id="name" required><br><br>

  <div class="macros-row">
    <div class="macro-input">
      <label for="calories">Calories:</label><br>
      <input type="number" name="calories" id="calories" step="1" required>
    </div>
    <div class="macro-input">
      <label for="protein">Protein (g):</label><br>
      <input type="number" name="protein" id="protein" step="0.1">
    </div>
    <div class="macro-input">
      <label for="carbs">Carbs (g):</label><br>
      <input type="number" name="carbs" id="carbs" step="0.1">
    </div>
    <div class="macro-input">
      <label for="fat">Fat (g):</label><br>
      <input type="number" name="fat" id="fat" step="0.1">
    </div>
  </div>

  <br>
  <button type="submit">Log Food</button>
</form>

<hr>

<h3>Logged Foods</h3>
<table>
    <tr>
        <th>Name</th><th>Calories</th><th>Protein</th><th>Carbs</th><th>Fat</th><th>Actions</th>
    </tr>
    {% for entry in entries %}
    <tr>
        <td>{{ entry[1] }}</td>
        <td>{{ entry[2] }}</td>
        <td>{{ entry[3] }}</td>
        <td>{{ entry[4] }}</td>
        <td>{{ entry[5] }}</td>
        <td>
            <a href="{{ url_for('edit_food', food_id=entry[0]) }}">Edit</a>
            <a href="#" onclick="if(confirm('Delete this entry?')) { document.getElementById('delete-form-{{ entry[0] }}').submit(); } return false;">Delete</a>

            <form id="delete-form-{{ entry[0] }}" method="POST" action="{{ url_for('delete_food', food_id=entry[0]) }}" style="display:none;"></form>

        </td>
    </tr>
    {% endfor %}
</table>

<hr>

<h3>Daily Totals</h3>
<div class="totals">
  {% for key, label in [('calories', 'Calories'), ('protein', 'Protein (g)'), ('carbs', 'Carbs (g)'), ('fat', 'Fat (g)')] %}
    <div class="total-row">
      <div class="total-text">{{ label }}: {{ "%.1f"|format(totals[key]) }} / {{ macro_targets[key] }}</div>
      <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="{{ macro_targets[key] }}" aria-valuenow="{{ totals[key] }}">
        <div
          class="progress-fill"
          style="width: {{ (totals[key] / macro_targets[key]) * 100 if macro_targets[key] else 0 }}%;"
        ></div>
      </div>
    </div>
  {% endfor %}
</div>


<script>
    const savedFoods = {
        {% for food in saved_foods %}
        "{{ food[1] }}": {},  // fix: use food[1] for name key
        {% endfor %}
    };

    async function fillMacros() {
        const selected = document.getElementById('saved-foods').value;
        if (!selected) return;

        const response = await fetch(`/api/saved-food/${encodeURIComponent(selected)}`);
        if (!response.ok) return;

        const data = await response.json();
        document.getElementById('name').value = selected;
        document.getElementById('calories').value = data.calories;
        document.getElementById('protein').value = data.protein;
        document.getElementById('carbs').value = data.carbs;
        document.getElementById('fat').value = data.fat;
    }
</script>

<script>
document.getElementById('food-form').addEventListener('submit', function(e) {
  const name = this.name.value.trim();
  const calories = parseFloat(this.calories.value);
  const protein = parseFloat(this.protein.value || 0);
  const carbs = parseFloat(this.carbs.value || 0);
  const fat = parseFloat(this.fat.value || 0);

  if (!name) {
    alert("Food name is required.");
    e.preventDefault();
    return;
  }
  if (isNaN(calories) || calories <= 0) {
    alert("Calories must be a positive number.");
    e.preventDefault();
    return;
  }
  if (protein < 0 || carbs < 0 || fat < 0) {
    alert("Macros cannot be negative.");
    e.preventDefault();
    return;
  }
});
</script>

{% endblock %}
