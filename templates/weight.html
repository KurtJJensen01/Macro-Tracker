{% extends "base.html" %}
{% block content %}

<!-- Weight Entry Form -->
<form method="POST" action="{{ url_for('weight_log') }}">
    <label>Date:</label>
    <input type="date" name="date" value="{{ datetime.utcnow().strftime('%Y-%m-%d') }}" required />

    <label>Time of Day:</label>
    <select name="time_of_day" required>
        <option value="">Select</option>
        <option value="morning">Morning</option>
        <option value="night">Night</option>
    </select>

    <label>Weight (lbs):</label>
    <input type="number" step="0.1" name="weight" required />

    <button type="submit">Add Weight</button>
</form>

<br><hr><br>

<!-- Tabs -->
<div>
    <button id="morningTabBtn">Morning</button>
    <button id="nightTabBtn">Night</button>
</div>

<!-- Morning Tab Content -->
<div id="morningTab" class="tabContent">
    <h3>Morning Weight Log</h3>
    <canvas id="morningChart"></canvas>

    <table border="1" cellpadding="5" cellspacing="0" style="width: 100%;">
        <thead>
            <tr>
                <th>Date</th>
                <th>Weight (lbs)</th>
                <th>Calories Consumed</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in morning_weights %}
            <tr>
                <td>{{ entry.date }}</td>
                <td>{{ entry.weight }}</td>
                <td>{{ morning_calories.get(entry.date, '-') }}</td>
                <td>
                    <form method="POST" action="{{ url_for('delete_weight', id=entry.id) }}" onsubmit="return confirm('Delete this entry?');">
                        <button type="submit">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Night Tab Content -->
<div id="nightTab" class="tabContent" style="display:none;">
    <h3>Night Weight Log</h3>
    <canvas id="nightChart"></canvas>

    <table border="1" cellpadding="5" cellspacing="0" style="width: 100%;">
        <thead>
            <tr>
                <th>Date</th>
                <th>Weight (lbs)</th>
                <th>Calories Consumed</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in night_weights %}
            <tr>
                <td>{{ entry.date }}</td>
                <td>{{ entry.weight }}</td>
                <td>{{ night_calories.get(entry.date, '-') }}</td>
                <td>
                    <form method="POST" action="{{ url_for('delete_weight', id=entry.id) }}" onsubmit="return confirm('Delete this entry?');">
                        <button type="submit">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Prepare labels (just dates)
    const morningLabels = [{% for entry in morning_weights %}'{{ entry.date }}',{% endfor %}];
    const morningWeights = [{% for entry in morning_weights %}{{ entry.weight }},{% endfor %}];
    // Calories array aligned with morningWeights
    const morningCals = [{% for entry in morning_weights %}{{ morning_calories.get(entry.date, 0) }},{% endfor %}];

    const nightLabels = [{% for entry in night_weights %}'{{ entry.date }}',{% endfor %}];
    const nightWeights = [{% for entry in night_weights %}{{ entry.weight }},{% endfor %}];
    const nightCals = [{% for entry in night_weights %}{{ night_calories.get(entry.date, 0) }},{% endfor %}];

    // Morning chart data and config
    const morningData = {
        labels: morningLabels,
        datasets: [{
            label: 'Morning Weight (lbs)',
            data: morningWeights,
            borderColor: 'rgba(75, 192, 192, 1)',
            tension: 0.3,
            fill: false,
            // Store calories in dataset for tooltip use
            calories: morningCals,
            pointRadius: 5,
            pointHoverRadius: 7,
        }]
    };

    // Night chart data and config
    const nightData = {
        labels: nightLabels,
        datasets: [{
            label: 'Night Weight (lbs)',
            data: nightWeights,
            borderColor: 'rgba(192, 75, 192, 1)',
            tension: 0.3,
            fill: false,
            calories: nightCals,
            pointRadius: 5,
            pointHoverRadius: 7,
        }]
    };

    // Common options with custom tooltip
    const options = {
        scales: {
            y: {
                beginAtZero: false,
                suggestedMin: 100,
                suggestedMax: 250
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const weight = context.parsed.y;
                        // Calories from dataset calories array at the hovered index
                        const cal = context.dataset.calories[context.dataIndex];
                        return `Weight: ${weight} lbs, Calories: ${cal}`;
                    }
                }
            }
        }
    };

    const morningCtx = document.getElementById('morningChart').getContext('2d');
    const morningChart = new Chart(morningCtx, {
        type: 'line',
        data: morningData,
        options: options
    });

    const nightCtx = document.getElementById('nightChart').getContext('2d');
    const nightChart = new Chart(nightCtx, {
        type: 'line',
        data: nightData,
        options: options
    });
</script>

{% endblock %}
